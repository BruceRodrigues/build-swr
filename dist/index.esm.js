import{useEffect as e,useLayoutEffect as n,createContext as r,useState as t,useRef as u,useCallback as i,useContext as o,useDebugValue as a}from"react";import{dequal as c}from"dequal/lite";var f=function(){return(f=Object.assign||function(e){for(var n,r=1,t=arguments.length;r<t;r++)for(var u in n=arguments[r])Object.prototype.hasOwnProperty.call(n,u)&&(e[u]=n[u]);return e}).apply(this,arguments)};function l(e,n,r,t){return new(r||(r=Promise))(function(u,i){function o(e){try{c(t.next(e))}catch(e){i(e)}}function a(e){try{c(t.throw(e))}catch(e){i(e)}}function c(e){e.done?u(e.value):new r(function(n){n(e.value)}).then(o,a)}c((t=t.apply(e,n||[])).next())})}function s(e,n){var r,t,u,i,o={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,t&&(u=2&i[0]?t.return:i[0]?t.throw||((u=t.return)&&u.call(t),0):t.next)&&!(u=u.call(t,i[1])).done)return u;switch(t=0,u&&(i=[2&i[0],u.value]),i[0]){case 0:case 1:u=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,t=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(u=o.trys,(u=u.length>0&&u[u.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!u||i[1]>u[0]&&i[1]<u[3])){o.label=i[1];break}if(6===i[0]&&o.label<u[1]){o.label=u[1],u=i;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(i);break}u[2]&&o.ops.pop(),o.trys.pop();continue}i=n.call(e,o)}catch(e){i=[6,e],t=0}finally{r=u=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var d={}[0],v=function(e){return e===d},h=!0,p="undefined"!=typeof window?window.addEventListener.bind(window):null,g="undefined"!=typeof document?document.addEventListener.bind(document):null,y={isOnline:function(){return h},isDocumentVisible:function(){if(g){var e=document.visibilityState;if(!v(e))return"hidden"!==e}return!0},registerOnFocus:function(e){p&&g&&(g("visibilitychange",function(){return e()}),p("focus",function(){return e()}))},registerOnReconnect:function(e){p&&(p("online",function(){h=!0,e()}),p("offline",function(){return h=!1}))}},b="undefined"==typeof window||!("undefined"==typeof Deno||!Deno.version||!Deno.version.deno),m=b?null:window.requestAnimationFrame,w=b?null:m?function(e){return m(e)}:function(e){return setTimeout(e,1)},O=b?e:n,V=!b&&navigator.connection&&-1!==["slow-2g","2g"].indexOf(navigator.connection.effectiveType),T=function(){};var R=f({onLoadingSlow:T,onSuccess:T,onError:T,onErrorRetry:function(e,n,r,t,u){if(y.isDocumentVisible()&&!("number"==typeof r.errorRetryCount&&u.retryCount>r.errorRetryCount)){var i=Math.min(u.retryCount,8),o=~~((Math.random()+.5)*(1<<i))*r.errorRetryInterval;setTimeout(t,o,u)}},revalidateOnFocus:!0,revalidateOnReconnect:!0,refreshWhenHidden:!1,refreshWhenOffline:!1,shouldRetryOnError:!0,suspense:!1,errorRetryInterval:V?1e4:5e3,focusThrottleInterval:5e3,dedupingInterval:2e3,loadingTimeout:V?5e3:3e3,refreshInterval:0,fetcher:function(e){return fetch(e).then(function(e){return e.json()})},compare:c,isPaused:function(){return!1},cache:new Map},y),S=new WeakMap,x=0;function I(e){var n=null;if("function"==typeof e)try{e=e()}catch(n){e=""}return Array.isArray(e)?(n=e,e=function(e){if(!e.length)return"";for(var n="arg",r=0;r<e.length;++r){var t=void 0;null===e[r]||"object"!=typeof e[r]&&"function"!=typeof e[r]?t=JSON.stringify(e[r]):S.has(e[r])?t=S.get(e[r]):(t=x,S.set(e[r],x++)),n+="@"+t}return n}(e)):e=String(e||""),[e,n,e?"err@"+e:"",e?"req@"+e:""]}var P=r({});function j(e,n){var r=t({})[1],o=u(e),a=u({data:!1,error:!1,isValidating:!1}),c=i(function(e){for(var t=!1,u=o.current,i=0,c=Object.keys(e);i<c.length;i++){var f=c[i];u[f]!==e[f]&&(u[f]=e[f],a.current[f]&&(t=!0))}t&&!n.current&&r({})},[]);return O(function(){o.current=e}),[o,a,c]}function D(e){var n=f(f(f({},R),o(P)),e.length>2?e[2]:2===e.length&&"object"==typeof e[1]?e[1]:{}),r=e.length>2||2===e.length&&"function"==typeof e[1]||null===e[1]?e[1]:n.fetcher;return[e[0],r,n]}P.displayName="SWRConfig";var E=0,W=function(){return++E},k=new WeakMap,C=function(e){return k.has(e)||k.set(e,[{},{},{},{},{},{},{}]),k.get(e)};if(!b){var M=C(R.cache),F=M[0],z=M[1],A=function(e){if(R.isDocumentVisible()&&R.isOnline())for(var n in e)e[n][0]&&e[n][0]()};R.registerOnFocus(function(){return A(F)}),R.registerOnReconnect(function(){return A(z)})}var L=function(e,n,r,t,u,i){void 0===i&&(i=!1);var o=C(e)[2][n],a=[];if(o)for(var c=0;c<o.length;++c)a.push(o[c](i,r,t,u,c>0));return Promise.all(a).then(function(){return e.get(n)})};function q(e,n,r,t){return void 0===t&&(t=!0),l(this,void 0,void 0,function(){var u,i,o,a,c,f,l,h,p,g,y,b;return s(this,function(s){switch(s.label){case 0:if(u=I(n),i=u[0],o=u[2],!i)return[2,d];if(a=C(e),c=a[3],f=a[4],v(r))return[2,L(e,i,e.get(i),e.get(o),d,t)];if(c[i]=W(),f[i]=0,l=c[i],g=!1,"function"==typeof r)try{r=r(e.get(i))}catch(e){r=d,p=e}if(!r||"function"!=typeof r.then)return[3,5];g=!0,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,r];case 2:return h=s.sent(),[3,4];case 3:return y=s.sent(),p=y,[3,4];case 4:return[3,6];case 5:h=r,s.label=6;case 6:return(b=function(){if(l!==c[i]){if(p)throw p;return!0}})()?[2,h]:(v(h)||e.set(i,h),e.set(o,p),f[i]=W(),!g&&b()?[2,h]:[2,L(e,i,h,p,d,t).then(function(e){if(p)throw p;return e})])}})})}var H=function(e,n,r){return e[n]?e[n].push(r):e[n]=[r],function(){var t=e[n],u=t.indexOf(r);u>=0&&(t[u]=t[t.length-1],t.pop())}};function N(){for(var e=this,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var t=D(n),o=t[0],c=t[1],h=t[2],p=h.cache,g=C(p),y=g[0],m=g[1],V=g[2],T=g[3],R=g[4],S=g[5],x=g[6],P=I(o),E=P[0],k=P[1],M=P[2],F=P[3],z=u(!1),A=u(!1),N=u(E),G=u(h),J=function(){var e=p.get(E);return v(e)?h.initialData:e},B=J(),K=p.get(M),Q=function(){return v(h.revalidateOnMount)?h.suspense?!z.current&&!v(B):v(h.initialData):h.revalidateOnMount},U=function(){return!!E&&(!!p.get(F)||!z.current&&Q())},X=U(),Y=i(function(e){A.current||E===N.current&&z.current&&e()},[E]),Z=j({data:B,error:K,isValidating:X},A),$=Z[0],_=Z[1],ee=Z[2],ne=i(function(n){return void 0===n&&(n={}),l(e,void 0,void 0,function(){var e,r,t,u,i,o,a,f,l,g;return s(this,function(s){switch(s.label){case 0:if(!E||!c)return[2,!1];if(A.current)return[2,!1];if(G.current.isPaused())return[2,!1];e=n.retryCount,r=void 0===e?0:e,t=n.dedupe,u=void 0!==t&&t,i=!0,o=!v(S[E])&&u,s.label=1;case 1:return s.trys.push([1,6,,7]),p.set(F,!0),ee({isValidating:!0}),o||L(p,E,$.current.data,$.current.error,!0),o?(f=x[E],[4,S[E]]):[3,3];case 2:return a=s.sent(),[3,5];case 3:return h.loadingTimeout&&!p.get(E)&&setTimeout(function(){i&&Y(function(){return G.current.onLoadingSlow(E,h)})},h.loadingTimeout),S[E]=null!==k?c.apply(void 0,k):c(E),x[E]=f=W(),[4,S[E]];case 4:a=s.sent(),setTimeout(function(){x[E]===f&&(delete S[E],delete x[E])},h.dedupingInterval),Y(function(){return G.current.onSuccess(a,E,h)}),s.label=5;case 5:return x[E]!==f?[2,!1]:!v(T[E])&&(f<=T[E]||f<=R[E]||0===R[E])?(ee({isValidating:!1}),[2,!1]):(p.set(M,d),p.set(F,!1),l={isValidating:!1},v($.current.error)||(l.error=d),h.compare($.current.data,a)||(l.data=a),h.compare(p.get(E),a)||p.set(E,a),ee(l),o||L(p,E,a,l.error,!1),[3,7]);case 6:return g=s.sent(),delete S[E],delete x[E],G.current.isPaused()?(ee({isValidating:!1}),[2,!1]):(p.set(M,g),$.current.error!==g&&(ee({isValidating:!1,error:g}),o||L(p,E,d,g,!1)),Y(function(){return G.current.onError(g,E,h)}),h.shouldRetryOnError&&Y(function(){return G.current.onErrorRetry(g,E,h,ne,{retryCount:r+1,dedupe:!0})}),[3,7]);case 7:return i=!1,[2,!0]}})})},[E]);if(O(function(){G.current=h}),O(function(){if(!E)return d;var e=z.current,n=function(){return ne({dedupe:!0})};A.current=!1,N.current=E,e&&ee({data:B,error:K,isValidating:X}),(e||Q())&&(v(B)||b?n():w(n));var r=!1,t=H(y,E,function(){!r&&G.current.revalidateOnFocus&&(r=!0,n(),setTimeout(function(){return r=!1},G.current.focusThrottleInterval))}),u=H(m,E,function(){G.current.revalidateOnReconnect&&n()}),i=H(V,E,function(e,r,t,u,i){return void 0===e&&(e=!0),void 0===i&&(i=!0),ee(f({error:t,isValidating:u},h.compare(r,$.current.data)?null:{data:r})),!!e&&(i?n:ne)()});return z.current=!0,function(){A.current=!0,t(),u(),i()}},[E,ne]),O(function(){var e=0;function n(){var n=G.current;n.refreshInterval&&(e=setTimeout(r,n.refreshInterval))}function r(){return l(this,void 0,void 0,function(){var r;return s(this,function(t){switch(t.label){case 0:return r=G.current,$.current.error||!r.refreshWhenHidden&&!r.isDocumentVisible()||!r.refreshWhenOffline&&!r.isOnline()?[3,2]:[4,ne({dedupe:!0})];case 1:t.sent(),t.label=2;case 2:return e&&n(),[2]}})})}return n(),function(){e&&(clearTimeout(e),e=0)}},[h.refreshInterval,h.refreshWhenHidden,h.refreshWhenOffline,ne]),h.suspense&&v(B)){if(v(K))throw ne({dedupe:!0});throw K}var re=i(function(e,n){return q(p,N.current,e,n)},[]),te={revalidate:ne,mutate:re},ue=_.current;return Object.defineProperties(te,{data:{get:function(){return ue.data=!0,B},enumerable:!0},error:{get:function(){return ue.error=!0,K},enumerable:!0},isValidating:{get:function(){return ue.isValidating=!0,X},enumerable:!0}}),a(B),te}var G=P.Provider;Object.defineProperty(G,"default",{value:R});var J=q.bind(null,R.cache);function B(e){var n=e;return{cache:n,mutate:q.bind(null,n)}}function K(){for(var e=this,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=D(n),a=o[0],c=o[1],f=o[2],h=f.cache,p=f.initialSize,g=void 0===p?1:p,y=f.revalidateAll,b=void 0!==y&&y,m=f.persistSize,w=void 0!==m&&m,V=null;try{V=I(a?a(0,null):null)[0]}catch(e){}var T=t({})[1],R=null;V&&(R="ctx@"+V);var S=null;V&&(S="len@"+V);var x=u(!1),P=i(function(){var e=h.get(S);return v(e)?g:e},[S,g]),j=u(P());O(function(){x.current?V&&h.set(S,w?j.current:g):x.current=!0},[V]);var E=u(),W=N(V?["inf",V]:null,function(){return l(e,void 0,void 0,function(){var e,n,r,t,u,i,o,l,d,p,g,y;return s(this,function(s){switch(s.label){case 0:e=h.get(R)||{},n=e.data,r=e.force,t=[],u=P(),i=null,o=0,s.label=1;case 1:return o<u?(l=I(a?a(o,i):null),d=l[0],p=l[1],d?(g=h.get(d),y=b||r||v(g)||v(r)&&0===o&&!v(E.current)||n&&!f.compare(n[o],g),c&&y?null===p?[3,3]:[4,c.apply(void 0,p)]:[3,6]):[3,8]):[3,8];case 2:return g=s.sent(),[3,5];case 3:return[4,c(d)];case 4:g=s.sent(),s.label=5;case 5:h.set(d,g),s.label=6;case 6:t.push(g),i=g,s.label=7;case 7:return++o,[3,1];case 8:return h.delete(R),[2,t]}})})},f);O(function(){E.current=W.data},[W.data]);var k=i(function(e,n){if(void 0===n&&(n=!0),!R)return d;if(n&&!v(e)){var r=E.current;h.set(R,{data:r,force:!1})}else n&&h.set(R,{force:!0});return W.mutate(e,n)},[R]),C=i(function(e){return S?("function"==typeof e?n=e(P()):"number"==typeof e&&(n=e),"number"==typeof n&&(h.set(S,n),j.current=n),T({}),k(function(e){return e})):d;var n},[S,P,k]),M={size:P(),setSize:C,mutate:k};return Object.defineProperties(M,{error:{get:function(){return W.error},enumerable:!0},data:{get:function(){return W.data},enumerable:!0},revalidate:{get:function(){return W.revalidate},enumerable:!0},isValidating:{get:function(){return W.isValidating},enumerable:!0}}),M}export default N;export{G as SWRConfig,B as createCache,J as mutate,K as useSWRInfinite};
